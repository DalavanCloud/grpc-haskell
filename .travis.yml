# See https://github.com/hvr/multi-ghc-travis for more information

language: c

sudo: false

matrix:
  include:
    - env: CABALVER=1.24 GHCVER=7.10.3 C_COMPILER=g++-4.8
      addons: {apt: {packages: [cabal-install-1.24,ghc-7.10.3,gcc-4.8,g++-4.8], sources: [hvr-ghc,ubuntu-toolchain-r-test]}}
    - env: CABALVER=1.24 GHCVER=8.0.2 C_COMPILER=g++-4.8
      addons: {apt: {packages: [cabal-install-1.24,ghc-8.0.2,gcc-4.8,g++-4.8], sources: [hvr-ghc,ubuntu-toolchain-r-testc]}}
    - env: CABALVER=head GHCVER=head C_COMPILER=g++-4.8
      addons: {apt: {packages: [cabal-install-head,ghc-head,gcc-4.8,g++-4.8],  sources: [hvr-ghc,ubuntu-toolchain-r-test]}}

  allow_failures:
    - env: CABALVER=head GHCVER=head

before_install:
 - export PATH=/opt/ghc/$GHCVER/bin:/opt/cabal/$CABALVER/bin:$PATH
 # Unfortunately it seems we have to fetch the full repository to be able to
 # clone it to create our workspace. We would be OK with a shallow repository
 # if we could make git to clone it.
 - if [[ -a .git/shallow ]]; then git fetch --unshallow; fi

install:
 - mkdir workspace
 - cp cabal.project.travis workspace/cabal.project
 - cd workspace
 - git clone --depth=1 .. grpc-haskell
 - git clone --depth=1 --recursive https://github.com/grpc/grpc grpc
 - cd grpc
 - CXX=$C_COMPILER make shared_c static_c interop_server -j
 - cd ..
 - cabal new-build --only-dependencies

script:
 - cabal new-build

notifications:
  email:
    - kolmodin@google.com
